'use strict';

var mongodb = require('mongodb');

var url = "mongodb://" + process.env.OPENSHIFT_NOSQL_DB_USERNAME +
       ":" + process.env.OPENSHIFT_NOSQL_DB_PASSWORD + "@" +
       process.env.OPENSHIFT_NOSQL_DB_HOST + ":" +
       process.env.OPENSHIFT_NOSQL_DB_PORT + "/" +
       process.env.OPENSHIFT_APP_NAME;

function connect(callback) {

  mongodb.connect(url, function (err, conn) {
    conn.on('error', function (err) {
      console.log('%s: Mongo connect error %s', Date(Date.now()), err);
      return undefined;
    });

    console.log('%s: Mongo connect success', Date(Date.now()));

    var result = callback(conn);

    return result;
  });
}

exports.connect = connect;

exports.parseObjectId = function (id) {
  try {
    return mongodb.ObjectID(id);
  } catch (err) {
    return null;
  }
};

exports.doc = {
  id: function (object_id, callback) {
    connect(function (conn) {
      conn.collection('doc', function (err, collection) {

        collection.findOne({"_id": object_id}, function (err, doc) {
          callback(conn, collection, err, doc);
        });

      });
    });
  }
};

